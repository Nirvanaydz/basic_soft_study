### 为什么会有AOF，是如何进行数据恢复的
> 实现数据的持久化，恢复数据时需要一条一条的执行aof日志文件中的写操作
---
### AOF如何产生，如何执行，存在哪些特点
> 写后日志：“写后”的意思是 Redis 是先执行命令，把数据写入内存，然后才记录日志
> 可以避免出现记录错误命令的情况
> 命令执行后再进行日志记录操作，不会阻塞你当前写操作
> tips：aof记录日志的方式是使用**主线程**执行的，会阻塞你下一次操作
---
### 控制AOF写回磁盘的时机
- 刚刚执行完写操作未完成写回时，服务器宕机，造成数据的丢失 
- 写回磁盘策略的使用，通过appendfsync参数控制
- 使用时遵循trade-off，取舍
---
|配置项|写回时机|优点|缺点|
| ----------- | ----------- | ----------- | ----------- | 
| always | 同步写回 | 可靠性高，数据基本不丢失 | 每个写命令都需要落盘，性能影响较大 | 
| everySec | 每秒写回 | 性能适中 | 宕机丢失一秒内未写回的数据 | 
| no | 操作系统控制写回 | 性能好 | 宕机丢失的数据较多 | 
---
### aof文件过大造成的问题及如何处理
- questions
    >+ 文件系统本身无法存储过大的文件
    >+ 文件过大追加命令时操作效率低
    >+ 文件过大时恢复数据的速度慢
- handles
    >+ aof重写机制：redis根据现有文件的现状新建一个aof日志，将一些操作指令合并，减少日志文件的大小
    >+ 为了避免阻塞主线程，重写使用后台子线程bgrewriteaof来完成重写操作
    >+ 一次拷贝：fork子线程bgrewriteaof时，会将主线程的内存拷贝一份给子线程
    + 两处日志：
        >- 主线程正在使用的aof日志，还是可以执行日志写回的日志，在重写日志未完成时用于宕机后的恢复
        >- 子线程正在创建的重写日志，当主线程有了新的写操作时，会在aof重写缓冲中也写入最新的写操作指令，保证两处日志的一致性
        >- 在重写日志完成创建后，替换掉原来使用的主线程aof旧日志文件

      