### 主从模式-数据少中断
- >数据少丢失，AOF和RDB完成
- >数据少中断，服务一直可用
### 如何完成一次数据全量同步
- >建立长连接
- >从库发起全量同步申请
- >主库fork子进程创建rdb数据库文件
- >将创建的rdb文件传输给从库
    + 为减少主库频繁创建rdb，可以使用主-从-从减少主库的全量同步压力
    + 为减少网络传输和提高加载的速度，单节点的实例建议在几GB即可，不要太大
- >从库接收到rdb，删除旧的数据库文件，加载rdb文件
### 如何进行增量同步，主库产生新的写操作
- >在主库中维护固定大小的环形链表缓冲区，**repl_backlog_buffer**
- >主库新增写入操作，主库的偏移量mater_repl_offset向前移动
- >从库有各自的salve_repl_offset
- >在网络中断时记录各个从库的同步位置
### 哨兵是什么
> 运行在特殊模式下的 Redis 进程，主从库实例运行的同时，它也在运行。
> 哨兵主要负责的就是三个任务：监控、选主（选择主库）和通知
- 监控
    > 监控是指哨兵进程在运行时，周期性地给所有的主从库发送 PING 命令，检测它们是否仍然在线运行。
    > 如果从库没有在规定时间内响应哨兵的 PING 命令，哨兵就会把它标记为“下线状态”；
    > 同样，如果主库也没有在规定时间内响应哨兵的 PING 命令，哨兵就会判定主库下线，然后开始自动切换主库的流程
    > 主观下线，一个哨兵自己的检测
    > 客观下线，多个哨兵的共识，且满足redis中的阈值设置
- 选主
    > 主库挂了以后，哨兵就需要从很多个从库里，按照一定的规则选择一个从库实例，把它作为新的主库
    > 网络好的，优先级高的，同步进度多的，从库ID小的从库成为新的主库
- 通知
    > 哨兵会把新主库的连接信息发给其他从库，让它们执行 replicaof 命令，和新主库建立连接，并进行数据复制
    > 哨兵会把新主库的连接信息通知给客户端，让它们把请求操作发到新主库上。
### 哨兵集群监控的前提，哨兵之间建立通信，哨兵存储主从节点的ip地址的端口信息
- 哨兵间如何建立通信：
    > 各个哨兵订阅主节点的__sentinel__:hello频道，互相知道各个哨兵的地址信息
- 哨兵如何获取从节点信息进行监控：
    > 向主节点发起INFO操作指令获取salve列表，完成从节点信息的获取，并建立连接
- 哨兵如何通知客户端新的主从节点信息：
    > 哨兵也是一个特殊的redis实例，可以实现发布订阅，将新切换的主从节点信息通知给客户端
- 哨兵选主，主从切换，通知从库同步，通知客户端更新连接信息的过程
    >1. 一个哨兵认为主库主观下线
    >2. 和多个哨兵协商，互相发送is-mater-down-by-addr指令
    >3. 协商后认为主库下线，此时主库被判断为客观下线
    >4. 哨兵集群内部进行选主，选出谁去执行这个主库下线和从库变主库的操作
    >5. 选主时互相投票，当获得半数以上的票数，并大于leader阈值quorum【法定人数】时，此哨兵获得主库switch操作
    >6. 选择网络好的，优先级高的，同步进度多的，从库ID小的从库成为新的主库
    >7. 通知其他从库进行数据同步，通知客户端更换主从节点信息
### redis cluster
- 槽位slot数量，16384，手动分配槽位时需要将所有的槽位都分配好
- 通过csc16和对槽位取模的方式找到通过哪个槽位获取数据
- 槽位和实例对应，一个实例可以对用一个或者多个槽位
- 当发生实例增加和删除动作时，原先的数据请求会发生槽位移动，从一个实例迁移到另一个实例中
    >+ 此时某个实例中没有要查询或者修改的信息，会给客户端发送moved 13332<sup>槽位id</sup> new-ip
      让后续的操作指令都移动到新实例中，会更新客户端的槽位对应信息
    >+ 当数据没有完全迁移成功时，旧实例还可以进行一段时间的操作，此时客户端会收到asking
      让指令还是发送到旧实例中，在完成数据迁移后，才会出现moved指令进行槽位数据的更新
