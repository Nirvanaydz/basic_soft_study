### 1、为什么会有负载均衡
- 访问域名时DNS服务器会获取对应的IP，有多个IP时
- 外网DNS使用的是GSLB（全局负载均衡），将用户分配到离他最近的服务器
- 内网DNS可以实现简单的轮询均衡，在考虑到失败机制等问题时，可以使用HaProxy和Nginx
- Nginx提供和HTTP的七层负载均衡，在1.9.01版本开始支持TCP的四层负载均衡
- 负载均衡的原理
    + 二层负载均衡
        - 改写报文的目标mac地址为上有服务器的mac地址，源IP和目标IP没有发生变化
        - 负载均衡服务器和真实服务器共享一个VIP
        - LVS DR工作模式就是如此
    + 四层负载均衡
        - 根据端口将报文发送到上游服务器（不同的IP地址+端口）
        - LVS NAT模式、HaProxy
    + 七层负载均衡
        - 根据端口号和应用层协议（如HTTP协议的主机名、URL），转发报文到上游服务器（不同的IP地址+端口）
        - HaProxy、Nginx
### 2、负载均衡需要关注的问题
- 上游服务器配置：使用upstream server配置上游服务器
    + 给Nginx配置上游服务器
    + 主要配置上游服务器的ip地址，端口号，权重
    + 再配置好反向代理，当访问nginx时，反向代理到配置好的upstream-server配置
- 负载均衡算法：配置多个上游服务器时的负载均衡机制
    + round robin
    + ip_hash
    + hash key
        - 对某一个key进行hash或者使用一致性hash
            + 什么是一致性hash
                - 使用一致性hash环的方式
                - 将要存储的服务器和要放置的对象hash到环上
                - 在哈希环上顺时针查找距离这个对象的 hash 值最近的机器，即是这个对象所属的机器
                - 增加服务器和减少服务器只需要很少的改变对象与服务器的关系
        - key e.g:uri，或者找寻cat类目下的某一个key进行hash，详见p22
- 失败重试机制：配置当超时或者上游服务器不存活时，是否需要重试其他上游服务器
    + max_fails
    + fail_timeout
    + 当在指定的失败时间内失败超过了最大设置次数的请求，认为此服务器不存活或者不可用
    + 在fail_timeout时间后将该服务器加入重试列表中进行重试
- 服务器心跳检查：上游服务器的健康检查/心跳检查
    + 默认使用惰性策略
    + TCP类型检查
        - interval：检测间隔时间
        - fall：失败多少次后标记为不可用
        - rise：成功多少次后标记为可用
        - timeout：检测请求超时时间配置
    + HTTP类型检测
        - 多出两个额外配置
        - check_http_send：检查发送的请求内容
        - check_http_expect_alive：上有服务器返回期望的状态码，标识其存活
### 3、如何实现动态负载均衡
- 启动upstream-server
- 在nginx机器上部署consul-template agent，使用长轮询监听业务变更
- consul-template监听到业务变更后，动态修改upstream列表
- 调用重启nginx，修改注册的服务器列表
### 4、nginx的TCP四层负载均衡和HTTP的七层负载均衡
- ？
